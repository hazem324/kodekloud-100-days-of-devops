# Resolve Dockerfile Issues

The Nautilus DevOps team is working to create new images as per requirements shared by the development team. One of the team members was working on a Dockerfile on **App Server 1 in Stratos DC**, but the Docker image build was failing due to multiple issues.
The task is to identify and fix those issues **without changing the base image or application data**.


---

## Steps

### 1. Login to App Server and inspect the Dockerfile

```sh
cat /opt/docker/Dockerfile
```

**Initial (broken) Dockerfile:**

```Dockerfile
IMAGE httpd:2.4.43

ADD sed -i "s/Listen 80/Listen 8080/g" /usr/local/apache2/conf/httpd.conf
ADD sed -i '/LoadModule\ ssl_module modules\/mod_ssl.so/s/^#//g' conf/httpd.conf
ADD sed -i '/LoadModule\ socache_shmcb_module modules\/mod_socache_shmcb.so/s/^#//g' conf/httpd.conf
ADD sed -i '/Include\ conf\/extra\/httpd-ssl.conf/s/^#//g' conf/httpd.conf

COPY certs/server.crt /usr/local/apache2/conf/server.crt
COPY certs/server.key /usr/local/apache2/conf/server.key
COPY html/index.html /usr/local/apache2/htdocs/
```

### 2. Identify the issues

The Dockerfile fails due to the following problems:

* ❌ `IMAGE` is not a valid Dockerfile instruction (must be `FROM`)
* ❌ `ADD` is incorrectly used to execute shell commands
* ❌ `RUN cp` was used for files not yet inside the image
* ❌ Apache configuration file paths were incorrect
* ❌ Files must be copied using `COPY` from build context

### 3. Fix the Dockerfile

**Corrected Dockerfile (Final Solution):**

```Dockerfile
FROM httpd:2.4.43

RUN sed -i "s/Listen 80/Listen 8080/g" /usr/local/apache2/conf/httpd.conf

RUN sed -i '/LoadModule ssl_module modules\/mod_ssl.so/s/^#//g' /usr/local/apache2/conf/httpd.conf

RUN sed -i '/LoadModule socache_shmcb_module modules\/mod_socache_shmcb.so/s/^#//g' /usr/local/apache2/conf/httpd.conf

RUN sed -i '/Include conf\/extra\/httpd-ssl.conf/s/^#//g' /usr/local/apache2/conf/httpd.conf

COPY certs/server.crt /usr/local/apache2/conf/server.crt
COPY certs/server.key /usr/local/apache2/conf/server.key
COPY html/index.html /usr/local/apache2/htdocs/
```

### 4. Build the Docker image

```sh
docker build -t test:test .
```

**Build Output (Successful):**

```text
[+] Building 5.9s (13/13) FINISHED
=> writing image sha256:a3ff1cbe531b871bec1bfb9ef199a87782289f861b5b43a821870196a6f8b3e8
=> naming to docker.io/library/test:test
```

### 5. Verify the image

```sh
docker images
```

The newly built image should now appear in the list.

---

## Key Fixes Summary

| Issue                       | Fix                                       |
| --------------------------- | ----------------------------------------- |
| Invalid `IMAGE` instruction | Replaced with `FROM`                      |
| `ADD` used to run commands  | Replaced with `RUN`                       |
| Incorrect file copy method  | Used `COPY` instead of `RUN cp`           |
| Wrong Apache config paths   | Used `/usr/local/apache2/conf/httpd.conf` |
| Build context errors        | Ensured files exist in context            |

---

## Good to Know

### COPY vs RUN cp

* **COPY** works with Docker build context (host → image)
* **RUN cp** works only inside the container filesystem
* Best practice: **Always use `COPY` for adding files**

### Dockerfile Debugging Tips

* Read error messages carefully
* Fix one error at a time
* Successful layers are cached
* Use absolute paths when modifying config files
* Base image OS matters more than host OS
