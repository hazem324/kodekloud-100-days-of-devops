# Resolve Volume Mount Mismatch – Nginx & PHP-FPM (Kubernetes)

We encountered an issue with our **Nginx + PHP-FPM multi-container Pod** where the website stopped working.

After investigation, the root cause was a **volume mount path mismatch** between containers and the nginx configuration.

This document explains how the issue was identified and fixed.

---

##  Problem Summary

* Pod name: `nginx-phpfpm`
* ConfigMap name: `nginx-config`
* Shared volume: `emptyDir`
* Issue: Containers were mounting the shared volume at different paths.
* Result: Nginx and PHP-FPM were not accessing the same document root.

---

##  Investigation

### 1. Check Pod Details

```bash
kubectl get pod nginx-phpfpm
kubectl describe pod nginx-phpfpm
```

### 2. Export Pod YAML

```bash
kubectl get pod nginx-phpfpm -o yaml > nginx-phpfpm.yml
```

### 3. Check ConfigMap

```bash
kubectl get configmap nginx-config -o yaml
```

Inside `nginx.conf`, we found:

```nginx
root /var/www/html;
```

This confirms the nginx document root is:

```
/var/www/html
```

---

##  Root Cause

The shared volume `shared-files` was mounted at:

* `/var/www/html` in one container
* `/usr/share/nginx/html` in the other container

Because of this mismatch:

* Nginx served from `/var/www/html`
* PHP-FPM executed from `/usr/share/nginx/html`
* Files were not aligned
* Website failed

---

## Solution

Both containers must mount the shared volume at the **same path**, matching the nginx root:

```
/var/www/html
```

---

##  Fix Steps

### 1. Edit Pod YAML

```bash
vi nginx-phpfpm.yml
```

Ensure both containers use:

```yaml
containers:
- image: php:7.2-fpm-alpine
  name: php-fpm-container
  volumeMounts:
  - mountPath: /var/www/html
    name: shared-files

- image: nginx:latest
  name: nginx-container
  volumeMounts:
  - mountPath: /var/www/html
    name: shared-files
  - mountPath: /etc/nginx/nginx.conf
    name: nginx-config-volume
    subPath: nginx.conf
```

> ⚠ Important: `subPath: nginx.conf` must be present.

---

### 2. Recreate the Pod

Volume mounts are immutable, so we must delete and recreate:

```bash
kubectl delete pod nginx-phpfpm
kubectl apply -f nginx-phpfpm.yml
```

Verify:

```bash
kubectl get pods
```

Status should be:

```
2/2 Running
```

---

### 3. Copy Application File

Copy `index.php` into nginx document root:

```bash
kubectl cp /home/thor/index.php nginx-phpfpm:/var/www/html/index.php -c nginx-container
```

---

### 4. Test

Option 1:

```bash
curl localhost:8080
```

---

## Good to Know

### Volume Troubleshooting

* **Mount Path Mismatch**: All containers sharing a volume must use the same mount path if the application expects a specific directory.
* **ConfigMap Issues**: Ensure the ConfigMap exists and is correctly referenced in the Pod spec.
* **Permission Problems**: Verify file ownership and permissions inside the container.
* **Volume Types**: Common types include `emptyDir`, `hostPath`, `PersistentVolumeClaim (PVC)`, `ConfigMap`, and `Secret`.

---

### Multi-Container Pods

* **Shared Volumes**: Containers inside the same Pod can share data using volumes.
* **Sidecar Pattern**: Helper containers run alongside the main container (e.g., PHP-FPM + Nginx).
* **Data Sharing**: Shared volumes enable file exchange between containers.
* **Log Aggregation**: Multiple containers can write logs to a shared location.

---

### ConfigMap Volumes

* **Configuration Files**: ConfigMaps allow injecting configuration into containers.
* **subPath**: Used to mount a specific file instead of the whole directory.
* **File Mode**: Permissions can be controlled using `defaultMode`.
* **Updates**: Changes to ConfigMap do not restart Pods automatically.

---

### Debugging Techniques

* **Describe Pod**:

  ```bash
  kubectl describe pod <pod-name>
  ```

  Displays events, conditions, and volume details.

* **Pod Logs**:

  ```bash
  kubectl logs <pod-name> -c <container-name>
  ```

* **Exec into Pod**:

  ```bash
  kubectl exec -it <pod-name> -c <container-name> -- /bin/sh
  ```

* **Volume Inspection**:
  Check mounted paths and verify file existence inside the container.


